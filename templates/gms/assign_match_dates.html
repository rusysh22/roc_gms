{% extends 'base.html' %}
{% load static %}

{% block title %}Assign Match Dates - {{ competition.name }}{% endblock %}

{% block extra_css %}
<style>
    .match-card {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        background-color: #f9fafb;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    
    .dark .match-card {
        background-color: #374151;
        border-color: #4b5563;
    }
    
    .match-header {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #1f2937;
        font-size: 0.95rem;
    }
    
    .dark .match-header {
        color: #f3f4f6;
    }
    
    .match-teams {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 0.5rem 0;
    }
    
    .team-box {
        background-color: #dbeafe;
        border: 1px solid #93c5fd;
        border-radius: 0.25rem;
        padding: 0.5rem 0.75rem;
        font-weight: 500;
        text-align: center;
        flex: 1;
        min-width: 0; /* Allow flex items to shrink below content */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.9rem;
    }
    
    .dark .team-box {
        background-color: #3730a3;
        border-color: #312e81;
        color: #e0e7ff;
    }
    
    .vs-separator {
        font-weight: bold;
        color: #6b7280;
        padding: 0 0.75rem;
        flex-shrink: 0;
    }
    
    .dark .vs-separator {
        color: #9ca3af;
    }
    
    .match-info {
        margin-bottom: 0.75rem;
        color: #4b5563;
        font-size: 0.8rem;
        display: flex;
        justify-content: space-between;
    }
    
    .dark .match-info {
        color: #d1d5db;
    }
    
    .date-time-container {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
        padding-top: 0.5rem;
        border-top: 1px solid #e5e7eb;
        margin-top: 0.5rem;
    }
    
    .dark .date-time-container {
        border-top-color: #4b5563;
    }
    
    .date-input, .time-input {
        width: 100%;
        max-width: 140px;
        padding: 0.4rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        background-color: white;
        font-size: 0.85rem;
    }
    
    .dark .date-input, .dark .time-input {
        background-color: #1f2937;
        border-color: #4b5563;
        color: #f9fafb;
    }
    
    .btn-primary {
        background-color: #3b82f6;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .btn-primary:hover {
        background-color: #2563eb;
    }
    
    .btn-secondary {
        background-color: #6b7280;
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .btn-secondary:hover {
        background-color: #4b5563;
    }
    
    .save-all-btn {
        background-color: #10b981;
        color: white;
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        font-weight: 600;
        margin-top: 1rem;
        font-size: 1rem;
    }
    
    .save-all-btn:hover {
        background-color: #059669;
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #111827;
        background-color: #f1f5f9;
        padding: 0.5rem 0.75rem;
        border-radius: 0.25rem;
        border-left: 3px solid #3b82f6;
    }
    
    .dark .section-title {
        color: #f9fafb;
        background-color: #1f2937;
        border-left-color: #60a5fa;
    }
    
    .round-divider {
        border-top: 1px solid #e5e7eb;
        margin: 1rem 0;
    }
    
    .dark .round-divider {
        border-color: #4b5563;
    }
    
    .flex-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .card-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8 dark:bg-gray-800">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Assign Match Dates - {{ competition.name }}</h1>
                <p class="text-lg text-gray-600 dark:text-gray-300 mt-2">
                    Set dates and times for scheduled matches before finalizing the competition schedule
                </p>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-xl p-6 mb-8">
        <h2 class="text-xl font-bold text-blue-800 dark:text-blue-200 mb-3">Instructions</h2>
        <ul class="list-disc list-inside space-y-2 text-blue-700 dark:text-blue-300">
            <li>Select a date and time for each draft match</li>
            <li>All matches must have dates assigned before finalizing the schedule</li>
            <li>Click "Save All Dates" to assign dates to all matches</li>
            <li>Click "Finalize Schedule" when all dates are assigned</li>
        </ul>
    </div>

    <!-- Form -->
    <form method="post">
        {% csrf_token %}
        
        {% if draft_matches %}
            <!-- Group matches by round with better naming -->
            {% regroup draft_matches by round_number as round_groups %}
            
            {% for round_group in round_groups %}
                <div class="mb-6">
                    <!-- Use the first match in the group to determine the round name -->
                    {% for match in round_group.list %}
                        {% if forloop.first %}
                            <h3 class="section-title">{{ match.get_friendly_round_name }}</h3>
                        {% endif %}
                    {% endfor %}
                    
                    <div class="round-divider"></div>
                    
                    <div class="card-container">
                    {% for match in round_group.list %}
                        <div class="match-card">
                            <div class="match-header">
                                <span class="font-medium">Match {{ forloop.counter }}:</span>
                            </div>
                            
                            <div class="match-teams">
                                <div class="team-box">
                                    {% if match.home_team %}{{ match.home_team.name }}{% else %}TBD{% endif %}
                                </div>
                                <div class="vs-separator">VS</div>
                                <div class="team-box">
                                    {% if match.away_team %}{{ match.away_team.name }}{% else %}TBD{% endif %}
                                </div>
                            </div>
                            
                            <div class="match-info">
                                <div><span class="font-medium">Round:</span> {{ match.round_number }}</div>
                                {% if match.group_number %}
                                    <div><span class="font-medium">Group:</span> {{ match.group_number }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="date-time-container">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        Date
                                    </label>
                                    <input 
                                        type="date" 
                                        name="match_date_{{ match.id }}" 
                                        id="date_{{ match.id }}"
                                        class="date-input"
                                        required
                                        value="{{ match.scheduled_time|date:'Y-m-d' }}"
                                    >
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        Time
                                    </label>
                                    <input 
                                        type="time" 
                                        name="match_time_{{ match.id }}" 
                                        id="time_{{ match.id }}"
                                        class="time-input"
                                        required
                                        value="{{ match.scheduled_time|time:'H:i' }}"
                                    >
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                </div>
            {% endfor %}
            
            <div class="flex flex-wrap gap-4">
                <button type="submit" class="save-all-btn">
                    üíæ Save All Dates
                </button>
                
                <a href="{% url 'gms:competition_detail' competition.id %}" class="btn-secondary">
                    ‚Üê Back to Competition
                </a>
            </div>
        {% else %}
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-xl p-6 text-center">
                <h3 class="text-lg font-medium text-yellow-800 dark:text-yellow-200">No Draft Matches</h3>
                <p class="mt-2 text-yellow-700 dark:text-yellow-300">
                    No draft matches found for this competition. Please generate matches first.
                </p>
                <a href="{% url 'gms:competition_detail' competition.id %}" class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">
                    Back to Competition
                </a>
            </div>
        {% endif %}
    </form>
</div>

<script>
// Set minimum date to today
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const dateInputs = document.querySelectorAll('input[type="date"]');
    
    dateInputs.forEach(input => {
        if (!input.value || input.value < today) {
            input.min = today;
        }
    });
    
    // Auto-populate time fields with a default time (e.g., 10:00) if empty
    const timeInputs = document.querySelectorAll('input[type="time"]');
    timeInputs.forEach(input => {
        if (!input.value) {
            input.value = '10:00';
        }
    });
});
</script>
{% endblock %}